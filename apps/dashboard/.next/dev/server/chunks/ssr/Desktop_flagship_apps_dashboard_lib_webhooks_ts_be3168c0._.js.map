{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/tr/Desktop/flagship/apps/dashboard/lib/webhooks.ts"],"sourcesContent":["import { db } from './firebase';\r\nimport { collection, addDoc, serverTimestamp } from 'firebase/firestore';\r\n\r\n// Webhook types\r\nexport type WebhookEvent = \r\n  | 'flag.created'\r\n  | 'flag.updated' \r\n  | 'flag.deleted'\r\n  | 'flag.toggled'\r\n  | 'targeting.updated';\r\n\r\nexport type WebhookProvider = 'slack' | 'discord' | 'custom';\r\n\r\nexport interface Webhook {\r\n  id: string;\r\n  projectId: string;\r\n  name: string;\r\n  url: string;\r\n  provider: WebhookProvider;\r\n  events: WebhookEvent[];\r\n  enabled: boolean;\r\n  secret?: string;\r\n  headers?: Record<string, string>;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n  lastTriggeredAt?: Date;\r\n}\r\n\r\nexport interface WebhookPayload {\r\n  event: WebhookEvent;\r\n  timestamp: string;\r\n  projectId: string;\r\n  data: {\r\n    flagKey?: string;\r\n    flagName?: string;\r\n    action: string;\r\n    actor: string;\r\n    changes?: any;\r\n    before?: any;\r\n    after?: any;\r\n  };\r\n}\r\n\r\nexport interface WebhookDelivery {\r\n  id: string;\r\n  webhookId: string;\r\n  event: WebhookEvent;\r\n  payload: WebhookPayload;\r\n  status: 'success' | 'failed' | 'pending';\r\n  statusCode?: number;\r\n  response?: string;\r\n  error?: string;\r\n  attemptCount: number;\r\n  deliveredAt?: Date;\r\n  createdAt: Date;\r\n}\r\n\r\n// Format payload for different providers\r\nexport function formatWebhookPayload(\r\n  webhook: Webhook,\r\n  payload: WebhookPayload\r\n): any {\r\n  switch (webhook.provider) {\r\n    case 'slack':\r\n      return formatSlackPayload(payload);\r\n    case 'discord':\r\n      return formatDiscordPayload(payload);\r\n    case 'custom':\r\n    default:\r\n      return payload;\r\n  }\r\n}\r\n\r\n// Slack message format\r\nfunction formatSlackPayload(payload: WebhookPayload): any {\r\n  const { event, data, timestamp } = payload;\r\n  \r\n  const emoji = getEventEmoji(event);\r\n  const color = getEventColor(event);\r\n  \r\n  return {\r\n    text: `${emoji} Feature Flag Event: ${event}`,\r\n    attachments: [\r\n      {\r\n        color: color,\r\n        fields: [\r\n          {\r\n            title: 'Event',\r\n            value: event,\r\n            short: true,\r\n          },\r\n          {\r\n            title: 'Flag',\r\n            value: data.flagKey || 'N/A',\r\n            short: true,\r\n          },\r\n          {\r\n            title: 'Action',\r\n            value: data.action,\r\n            short: true,\r\n          },\r\n          {\r\n            title: 'Actor',\r\n            value: data.actor || 'System',\r\n            short: true,\r\n          },\r\n          ...(data.changes ? [{\r\n            title: 'Changes',\r\n            value: `\\`\\`\\`${JSON.stringify(data.changes, null, 2)}\\`\\`\\``,\r\n            short: false,\r\n          }] : []),\r\n        ],\r\n        footer: 'Flagship Feature Flags',\r\n        ts: new Date(timestamp).getTime() / 1000,\r\n      },\r\n    ],\r\n  };\r\n}\r\n\r\n// Discord message format\r\nfunction formatDiscordPayload(payload: WebhookPayload): any {\r\n  const { event, data, timestamp } = payload;\r\n  \r\n  const emoji = getEventEmoji(event);\r\n  const color = getEventColorHex(event);\r\n  \r\n  return {\r\n    content: `${emoji} **Feature Flag Event:** ${event}`,\r\n    embeds: [\r\n      {\r\n        color: color,\r\n        fields: [\r\n          {\r\n            name: 'Event',\r\n            value: event,\r\n            inline: true,\r\n          },\r\n          {\r\n            name: 'Flag',\r\n            value: data.flagKey || 'N/A',\r\n            inline: true,\r\n          },\r\n          {\r\n            name: 'Action',\r\n            value: data.action,\r\n            inline: true,\r\n          },\r\n          {\r\n            name: 'Actor',\r\n            value: data.actor || 'System',\r\n            inline: true,\r\n          },\r\n          ...(data.changes ? [{\r\n            name: 'Changes',\r\n            value: `\\`\\`\\`json\\n${JSON.stringify(data.changes, null, 2)}\\n\\`\\`\\``,\r\n            inline: false,\r\n          }] : []),\r\n        ],\r\n        footer: {\r\n          text: 'Flagship Feature Flags',\r\n        },\r\n        timestamp: timestamp,\r\n      },\r\n    ],\r\n  };\r\n}\r\n\r\n// Helper functions\r\nfunction getEventEmoji(event: WebhookEvent): string {\r\n  switch (event) {\r\n    case 'flag.created': return 'üéâ';\r\n    case 'flag.updated': return '‚úèÔ∏è';\r\n    case 'flag.deleted': return 'üóëÔ∏è';\r\n    case 'flag.toggled': return 'üîÑ';\r\n    case 'targeting.updated': return 'üéØ';\r\n    default: return 'üì¢';\r\n  }\r\n}\r\n\r\nfunction getEventColor(event: WebhookEvent): string {\r\n  switch (event) {\r\n    case 'flag.created': return 'good';\r\n    case 'flag.updated': return 'warning';\r\n    case 'flag.deleted': return 'danger';\r\n    case 'flag.toggled': return '#36a64f';\r\n    case 'targeting.updated': return '#439FE0';\r\n    default: return '#808080';\r\n  }\r\n}\r\n\r\nfunction getEventColorHex(event: WebhookEvent): number {\r\n  switch (event) {\r\n    case 'flag.created': return 0x36a64f; // Green\r\n    case 'flag.updated': return 0xff9800; // Orange\r\n    case 'flag.deleted': return 0xf44336; // Red\r\n    case 'flag.toggled': return 0x2196f3; // Blue\r\n    case 'targeting.updated': return 0x9c27b0; // Purple\r\n    default: return 0x808080; // Gray\r\n  }\r\n}\r\n\r\n// Send webhook\r\nexport async function sendWebhook(\r\n  webhook: Webhook,\r\n  payload: WebhookPayload\r\n): Promise<{ success: boolean; statusCode?: number; error?: string }> {\r\n  if (!webhook.enabled) {\r\n    return { success: false, error: 'Webhook is disabled' };\r\n  }\r\n\r\n  try {\r\n    const formattedPayload = formatWebhookPayload(webhook, payload);\r\n    \r\n    const headers: Record<string, string> = {\r\n      'Content-Type': 'application/json',\r\n      'User-Agent': 'Flagship-Webhooks/1.0',\r\n      ...(webhook.headers || {}),\r\n    };\r\n\r\n    // Add signature if secret is provided\r\n    if (webhook.secret) {\r\n      const signature = await generateSignature(\r\n        JSON.stringify(formattedPayload),\r\n        webhook.secret\r\n      );\r\n      headers['X-Flagship-Signature'] = signature;\r\n    }\r\n\r\n    const response = await fetch(webhook.url, {\r\n      method: 'POST',\r\n      headers,\r\n      body: JSON.stringify(formattedPayload),\r\n      signal: AbortSignal.timeout(10000), // 10s timeout\r\n    });\r\n\r\n    const success = response.ok;\r\n    const statusCode = response.status;\r\n\r\n    // Log delivery\r\n    await logWebhookDelivery({\r\n      webhookId: webhook.id,\r\n      event: payload.event,\r\n      payload,\r\n      status: success ? 'success' : 'failed',\r\n      statusCode,\r\n      response: success ? await response.text() : undefined,\r\n      error: success ? undefined : `HTTP ${statusCode}: ${response.statusText}`,\r\n      attemptCount: 1,\r\n    });\r\n\r\n    return { success, statusCode };\r\n  } catch (error: any) {\r\n    // Log failed delivery\r\n    await logWebhookDelivery({\r\n      webhookId: webhook.id,\r\n      event: payload.event,\r\n      payload,\r\n      status: 'failed',\r\n      error: error.message,\r\n      attemptCount: 1,\r\n    });\r\n\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n\r\n// Generate HMAC signature\r\nasync function generateSignature(payload: string, secret: string): Promise<string> {\r\n  const encoder = new TextEncoder();\r\n  const data = encoder.encode(payload);\r\n  const key = encoder.encode(secret);\r\n\r\n  // Import key for HMAC\r\n  const cryptoKey = await crypto.subtle.importKey(\r\n    'raw',\r\n    key,\r\n    { name: 'HMAC', hash: 'SHA-256' },\r\n    false,\r\n    ['sign']\r\n  );\r\n\r\n  // Generate signature\r\n  const signature = await crypto.subtle.sign('HMAC', cryptoKey, data);\r\n\r\n  // Convert to hex\r\n  return Array.from(new Uint8Array(signature))\r\n    .map(b => b.toString(16).padStart(2, '0'))\r\n    .join('');\r\n}\r\n\r\n// Log webhook delivery\r\nasync function logWebhookDelivery(\r\n  delivery: Omit<WebhookDelivery, 'id' | 'createdAt' | 'deliveredAt'>\r\n): Promise<void> {\r\n  try {\r\n    await addDoc(collection(db, 'webhook_deliveries'), {\r\n      ...delivery,\r\n      createdAt: serverTimestamp(),\r\n      deliveredAt: delivery.status === 'success' ? serverTimestamp() : null,\r\n    });\r\n  } catch (error) {\r\n    console.error('Failed to log webhook delivery:', error);\r\n  }\r\n}\r\n\r\n// Trigger webhooks for an event\r\nexport async function triggerWebhooks(\r\n  projectId: string,\r\n  event: WebhookEvent,\r\n  data: WebhookPayload['data']\r\n): Promise<void> {\r\n  const { collection: firestoreCollection, query, where, getDocs } = await import('firebase/firestore');\r\n  \r\n  try {\r\n    // Get all enabled webhooks for this project that listen to this event\r\n    const webhooksQuery = query(\r\n      firestoreCollection(db, 'webhooks'),\r\n      where('projectId', '==', projectId),\r\n      where('enabled', '==', true),\r\n      where('events', 'array-contains', event)\r\n    );\r\n\r\n    const webhooksSnapshot = await getDocs(webhooksQuery);\r\n\r\n    if (webhooksSnapshot.empty) {\r\n      return;\r\n    }\r\n\r\n    const payload: WebhookPayload = {\r\n      event,\r\n      timestamp: new Date().toISOString(),\r\n      projectId,\r\n      data,\r\n    };\r\n\r\n    // Send to all matching webhooks (in parallel)\r\n    const promises = webhooksSnapshot.docs.map(doc => {\r\n      const webhook = { id: doc.id, ...doc.data() } as Webhook;\r\n      return sendWebhook(webhook, payload);\r\n    });\r\n\r\n    await Promise.allSettled(promises);\r\n  } catch (error) {\r\n    console.error('Failed to trigger webhooks:', error);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}